-- =====================================
-- AUTO TRADE RUM (CLIENT FINAL)
-- GIVE: name + UID
-- RECEIVE: name only
-- =====================================

local Players = game:GetService("Players")
local lp = Players.LocalPlayer

-- ================= PATH =================
local TradeGui = lp.PlayerGui.GameGui.Screen.Middle.Trade.Items.Container.Items

local GiveSF =
	TradeGui.Left.Give.Items.ScrollingFrame

local ReceiveSF =
	TradeGui.Right.Receive.Items.ScrollingFrame

-- ================= STORAGE =================
local TradeRum = {
	Give = {},     -- [name] = {uid, uid, ...}
	Receive = {}   -- [name] = true
}

local PendingGiveUIDs = {}

-- ================= UTILS =================
local function scanUID(v, cb)
	if type(v) == "string" and string.find(v, "unique_") then
		cb(v)
	elseif type(v) == "table" then
		for _, x in pairs(v) do
			scanUID(x, cb)
		end
	end
end

local function getUnitNameFromItem(item)
	for _, d in ipairs(item:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end
end

local function addGive(name, uid)
	TradeRum.Give[name] = TradeRum.Give[name] or {}
	table.insert(TradeRum.Give[name], uid)
	print("[GIVE]", name, uid)
end

local function addReceive(name)
	if not TradeRum.Receive[name] then
		TradeRum.Receive[name] = true
		print("[RECEIVE]", name)
	end
end

-- ================= REMOTE HOOK =================
local mt = getrawmetatable(game)
setreadonly(mt, false)

local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
	local args = {...}
	local method = getnamecallmethod()

	if method == "InvokeServer"
		and tostring(self) == "TradeAddToOffer" then

		-- ❗ ห้าม yield
		task.defer(function()
			for _, v in ipairs(args) do
				scanUID(v, function(uid)
					table.insert(PendingGiveUIDs, uid)
					print("[UID QUEUED]", uid)
				end)
			end
		end)
	end

	return old(self, ...)
end)

-- ================= GIVE LISTENER =================
GiveSF.ChildAdded:Connect(function(child)
	task.defer(function()
		local name = getUnitNameFromItem(child)
		if not name then return end

		local uid = table.remove(PendingGiveUIDs, 1)
		if not uid then
			print("[GIVE] name found but no uid:", name)
			return
		end

		addGive(name, uid)
	end)
end)

-- ================= RECEIVE LISTENER =================
ReceiveSF.ChildAdded:Connect(function(child)
	task.defer(function()
		local name = getUnitNameFromItem(child)
		if name then
			addReceive(name)
		end
	end)
end)

-- ================= READY =================
print("AUTO TRADE RUM READY")
