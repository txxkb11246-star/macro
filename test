-- =====================================
-- AUTO TRADE RUM (FIXED FINAL)
-- GIVE: name + UID
-- RECEIVE: name only
-- =====================================

local Players = game:GetService("Players")
local lp = Players.LocalPlayer

-- ================= SAFE WAIT =================
local function WFC(p, n)
	return p:WaitForChild(n, 10)
end

-- ================= PATH =================
local gui = WFC(lp, "PlayerGui")
gui = WFC(gui, "GameGui")
gui = WFC(gui, "Screen")
gui = WFC(gui, "Middle")
gui = WFC(gui, "Trade")
gui = WFC(gui, "Items")
gui = WFC(gui, "Container")
gui = WFC(gui, "Items")

local GiveSF =
	WFC(WFC(WFC(gui, "Left"), "Give"), "Items"):WaitForChild("ScrollingFrame")

local ReceiveSF =
	WFC(WFC(WFC(gui, "Right"), "Receive"), "Items"):WaitForChild("ScrollingFrame")

-- ================= STORAGE =================
local TradeRum = {
	Give = {},
	Receive = {}
}

local PendingGiveUIDs = {}

-- ================= UTILS =================
local function scanUID(v, cb)
	if type(v) == "string" and v:find("unique_") then
		cb(v)
	elseif type(v) == "table" then
		for _, x in pairs(v) do
			scanUID(x, cb)
		end
	end
end

local function getUnitNameFromItem(item)
	for _, d in ipairs(item:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end
end

local function addGive(name, uid)
	TradeRum.Give[name] = TradeRum.Give[name] or {}
	table.insert(TradeRum.Give[name], uid)
	print("[GIVE]", name, uid)
end

local function addReceive(name)
	if not TradeRum.Receive[name] then
		TradeRum.Receive[name] = true
		print("[RECEIVE]", name)
	end
end

-- ================= REMOTE HOOK =================
local mt = getrawmetatable(game)
setreadonly(mt, false)

local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
	local args = {...}
	local method = getnamecallmethod()
	local rname = tostring(self)

	if rname == "TradeAddToOffer"
		and (method == "InvokeServer" or method == "FireServer") then

		task.defer(function()
			for _, v in ipairs(args) do
				scanUID(v, function(uid)
					table.insert(PendingGiveUIDs, uid)
					print("[UID QUEUED]", uid)
				end)
			end
		end)
	end

	return old(self, ...)
end)

-- ================= GIVE LISTENER =================
GiveSF.ChildAdded:Connect(function(child)
	task.defer(function()
		local name = getUnitNameFromItem(child)
		if not name then
			print("[GIVE] no name")
			return
		end

		local uid = table.remove(PendingGiveUIDs, 1)
		if not uid then
			print("[GIVE]", name, "(uid not yet)")
			return
		end

		addGive(name, uid)
	end)
end)

-- ================= RECEIVE LISTENER =================
ReceiveSF.ChildAdded:Connect(function(child)
	task.defer(function()
		local name = getUnitNameFromItem(child)
		if name then
			addReceive(name)
		end
	end)
end)

-- ================= READY =================
print("AUTO TRADE RUM READY (FIXED)")
