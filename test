-- =========================================
-- AUTO TRADE CACHE : ID (REMOTE) + NAME (GUI)
-- =========================================

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local TradeAdd = RS.RemoteFunctions.TradeAddToOffer

-- GUI PATH (Give side)
local GiveSF =
	player.PlayerGui.GameGui.Screen.Middle.Trade
	.Items.Container.Items.Left.Give.Items.ScrollingFrame

-- Cache
getgenv().CachedUnits = getgenv().CachedUnits or {}

local function cache(name, id)
	if not name or not id then return end
	getgenv().CachedUnits[name] = getgenv().CachedUnits[name] or {}

	for _, v in ipairs(getgenv().CachedUnits[name]) do
		if v == id then
			return
		end
	end

	table.insert(getgenv().CachedUnits[name], id)
	print("[CACHED]", name, id)
end

-- หา "ชื่อ unit ล่าสุด" จาก Give GUI
local function getLatestUnitName()
	local items = GiveSF:GetChildren()
	if #items == 0 then return nil end

	-- item ล่าสุด (ตัวที่เพิ่งถูก add)
	local last = items[#items]

	-- หา TextLabel ที่เป็นชื่อ
	for _, d in ipairs(last:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end

	return nil
end

-- scan หา id แบบ recursive (กัน table ซ้อน)
local function scanForId(value, callback)
	if type(value) == "string" then
		if string.find(value, "unique_") then
			callback(value)
		end
	elseif type(value) == "table" then
		for _, v in pairs(value) do
			scanForId(v, callback)
		end
	end
end

-- ===============================
-- REMOTE HOOK
-- ===============================

local mt = getrawmetatable(game)
setreadonly(mt, false)
local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
	local args = {...}
	local method = getnamecallmethod()

	if method == "InvokeServer" and self == TradeAdd then
		-- รอ GUI อัปเดต 1 เฟรม
		task.wait()

		local unitName = getLatestUnitName()

		scanForId(args, function(id)
			cache(unitName or "UNKNOWN", id)
		end)
	end

	return old(self, ...)
end)

print("AUTO TRADE NAME+ID CACHE READY")
