-- ================== CONFIG ==================
local RUN_ONLY_USERNAME = "dusfuxxx"

local rawUsernames = [[
vvumvwij6719
stze19ofyh98
vtlc94zryf55
lohn37qbhk02
xgaldeel1283
iivq10smkp58
jqemtnuz0798
ubsutlek1709
uclheyrg5377
nsyznywn6464
]]

local addUnits = {"unit_potato"}
local repeatCounts = {
    unit_potato = 1
}

local wantedReceiveUnits = {} -- ว่าง = รับอะไรก็ได้
local NO_UNIT_TIMEOUT = 90 -- 1 นาทีครึ่ง (วินาที)

-- ================== SERVICES ==================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
if player.Name ~= RUN_ONLY_USERNAME then return end

-- ================== USER LIST ==================
local allowedUsernames = {}
for name in rawUsernames:gmatch("%S+") do
    table.insert(allowedUsernames, name)
end

local function isAllowed(name)
    for _, v in ipairs(allowedUsernames) do
        if v == name then return true end
    end
    return false
end

-- ================== UI ==================
local gui = Instance.new("ScreenGui")
gui.Name = "TradeStatusUI"
gui.ResetOnSpawn = false
gui.Parent = player.PlayerGui

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.32, 0.26)
frame.Position = UDim2.fromScale(0.5, 0.5)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.BackgroundColor3 = Color3.fromRGB(0,0,0)
frame.BackgroundTransparency = 0.15
frame.BorderColor3 = Color3.fromRGB(255,255,255)
frame.BorderSizePixel = 1

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 18)

local layout = Instance.new("UIListLayout", frame)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.Padding = UDim.new(0, 12)

local pad = Instance.new("UIPadding", frame)
pad.PaddingTop = UDim.new(0, 20)
pad.PaddingBottom = UDim.new(0, 20)

local title = Instance.new("TextLabel", frame)
title.Text = "TRADE AUTOMATION"
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.AutomaticSize = Enum.AutomaticSize.Y

local statusLabel = Instance.new("TextLabel", frame)
statusLabel.Text = "Idle"
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 16
statusLabel.TextColor3 = Color3.fromRGB(220,220,220)
statusLabel.BackgroundTransparency = 1
statusLabel.AutomaticSize = Enum.AutomaticSize.Y

local counterLabel = Instance.new("TextLabel", frame)
counterLabel.Text = "Trades completed: 0"
counterLabel.Font = Enum.Font.GothamMedium
counterLabel.TextSize = 15
counterLabel.TextColor3 = Color3.fromRGB(200,200,200)
counterLabel.BackgroundTransparency = 1
counterLabel.AutomaticSize = Enum.AutomaticSize.Y

local function setStatus(text)
    statusLabel.Text = text
end

-- ================== STATE ==================
local tradeCount = 0
local countedThisTrade = false

local function countTrade()
    if countedThisTrade then return end
    countedThisTrade = true
    tradeCount += 1
    counterLabel.Text = "Trades completed: " .. tradeCount
end

-- ================== CLOSE BUTTON ==================
local function fireCloseTrade()
    local closePath = player.PlayerGui.GameGui.Screen.Middle.Trade.Items.Close
    local obj = closePath
    while obj do
        if obj:IsA("GuiButton") then
            for _, c in ipairs(getconnections(obj.MouseButton1Click)) do
                pcall(function() c:Fire() end)
            end
            return
        end
        obj = obj.Parent
    end
end

-- ================== ADD UNIT (ORIGINAL LOGIC) ==================
local function addUnit(trade, unitName, amount)
    local scrolling = trade.Inventory.Inventory.Frame.Items.Items.ScrollingFrame
    local unitFrame = scrolling:FindFirstChild(unitName)
    if not unitFrame then return end

    local button = unitFrame:FindFirstChildWhichIsA("TextButton", true)
    if not button then return end

    for i = 1, amount do
        for _, c in ipairs(getconnections(button.MouseButton1Click)) do
            pcall(function() c:Fire() end)
        end
        task.wait(0.15)

        local addBtn = trade.AmountAdd.Frame.Frame.Actions.Items.Add
        for _, c in ipairs(getconnections(addBtn.MouseButton1Click)) do
            pcall(function() c:Fire() end)
        end
        task.wait(0.3)
    end
end

-- ================== HANDLE TRADE ==================
local function handleTrade(trade)
    countedThisTrade = false
    setStatus("Trade opened")

    -- Accept Terms (รอจนหาย)
    while trade.Terms.Visible do
        local acceptBtn = trade.Terms.Items.Buttons.Items.Accept
        for _, c in ipairs(getconnections(acceptBtn.MouseButton1Click)) do
            pcall(function() c:Fire() end)
        end
        task.wait(0.4)
    end

    setStatus("Adding units")

    for _, unit in ipairs(addUnits) do
        addUnit(trade, unit, repeatCounts[unit] or 1)
    end

    setStatus("Monitoring opponent")

    local receiveFrame =
        player.PlayerGui.GameGui.Screen.Middle.Trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame
    local acceptBtn =
        player.PlayerGui.GameGui.Screen.Middle.Trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept

    local lastChange = tick()
    local lastCount = 0

    while trade.Parent do
        local count = 0
        for _, f in ipairs(receiveFrame:GetChildren()) do
            if f:IsA("Frame") then
                count += 1
            end
        end

        if count ~= lastCount then
            lastCount = count
            lastChange = tick()
        end

        if count > 0 then
            for _, c in ipairs(getconnections(acceptBtn.MouseButton1Click)) do
                pcall(function() c:Fire() end)
            end
        elseif tick() - lastChange >= NO_UNIT_TIMEOUT then
            setStatus("No items received - closing trade")
            fireCloseTrade()
            return
        end

        task.wait(0.3)
    end
end

-- ================== MAIN LOOP ==================
spawn(function()
    local middle = player.PlayerGui.GameGui.Screen.Middle
    local currentTrade = nil

    while true do
        for _, p in ipairs(Players:GetPlayers()) do
            if isAllowed(p.Name) then
                pcall(function()
                    ReplicatedStorage.RemoteFunctions.TradeAcceptInvite:InvokeServer(p)
                end)
            end
        end

        local trade = middle:FindFirstChild("Trade")
        if trade and trade ~= currentTrade then
            currentTrade = trade
            handleTrade(trade)
        elseif not trade and currentTrade then
            setStatus("Trade completed")
            countTrade()
            currentTrade = nil
            setStatus("Waiting for next trade")
        end

        task.wait(1)
    end
end)
