-- =================================================
-- UNIT UID FULL SCAN & STORE (SCAN ONLY)
-- =================================================

local Players = game:GetService("Players")
local lp = Players.LocalPlayer

-- ================= SAFE WFC =================
local function WFC(p,n) return p:WaitForChild(n,10) end

-- ================= GUI PATH =================
local gui = WFC(lp,"PlayerGui")
gui = WFC(gui,"GameGui")
gui = WFC(gui,"Screen")
gui = WFC(gui,"Middle")
gui = WFC(gui,"Trade")
gui = WFC(gui,"Items")
gui = WFC(gui,"Container")
gui = WFC(gui,"Items")

local GiveSF =
	WFC(WFC(WFC(gui,"Left"),"Give"),"Items"):WaitForChild("ScrollingFrame")

-- ================= STORAGE =================
-- UnitStore[name] = { "unique_xxx", ... }
local UnitStore = {}
local PendingQueue = {} -- FIFO UID queue

-- ================= UTILS =================
local function getUnitName(item)
	for _,d in ipairs(item:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end
end

local function addUnit(name, uid)
	UnitStore[name] = UnitStore[name] or {}
	table.insert(UnitStore[name], uid)
	print("[SCAN]", name, uid)
end

local function popPending()
	if #PendingQueue == 0 then return nil end
	return table.remove(PendingQueue, 1)
end

-- ================= REMOTE SCAN =================
local mt = getrawmetatable(game)
setreadonly(mt,false)
local old = mt.__namecall

mt.__namecall = newcclosure(function(self,...)
	local args = {...}
	local method = getnamecallmethod()

	-- สแกนทุก remote ที่ส่ง unique_ ออกมา
	if method == "InvokeServer" or method == "FireServer" then
		for _,v in ipairs(args) do
			if type(v) == "string" and v:find("unique_") then
				table.insert(PendingQueue, v)
			elseif type(v) == "table" then
				for _,x in pairs(v) do
					if type(x)=="string" and x:find("unique_") then
						table.insert(PendingQueue, x)
					end
				end
			end
		end
	end

	return old(self,...)
end)

-- ================= GUI MATCH =================
GiveSF.ChildAdded:Connect(function(child)
	task.defer(function()
		local name = getUnitName(child)
		if not name then return end

		local uid = popPending()
		if uid then
			addUnit(name, uid)
		else
			print("[WARN] UID NOT FOUND FOR", name)
		end
	end)
end)

-- ================= PUBLIC ACCESS =================
_G.UnitScan = {}

-- ดึง UID ทั้งหมดของชื่อที่ต้องการ
function _G.UnitScan.Get(name)
	return UnitStore[name]
end

-- ดูทั้งหมด
function _G.UnitScan.Dump()
	for name,list in pairs(UnitStore) do
		print("====", name, "====")
		for i,uid in ipairs(list) do
			print(i, uid)
		end
	end
end

print("UNIT UID FULL SCAN READY (SCAN ONLY)")
print("USE: _G.UnitScan.Get(name) / _G.UnitScan.Dump()")
