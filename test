-- =========================================
-- TRADE GIVE + RECEIVE UNIT TRACKER
-- =========================================

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local TradeAdd = RS.RemoteFunctions.TradeAddToOffer

-- GUI PATHS
local TradeGui =
	player.PlayerGui.GameGui.Screen.Middle.Trade
local GiveSF =
	TradeGui.Items.Container.Items.Left.Give.Items.ScrollingFrame
local ReceiveSF =
	TradeGui.Items.Container.Items.Right.Receive.Items.ScrollingFrame

-- GLOBAL CACHE
getgenv().TradeCache = {
	Give = {},      -- [unitName] = { ids }
	Receive = {}    -- { unitName1, unitName2 }
}

-- ===============================
-- UTIL
-- ===============================

local function getUnitNameFromItem(item)
	for _, d in ipairs(item:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end
	return nil
end

local function getLatestName(scrollingFrame)
	local items = scrollingFrame:GetChildren()
	if #items == 0 then return nil end
	return getUnitNameFromItem(items[#items])
end

local function addGive(name, id)
	if not name or not id then return end
	getgenv().TradeCache.Give[name] =
		getgenv().TradeCache.Give[name] or {}

	for _, v in ipairs(getgenv().TradeCache.Give[name]) do
		if v == id then return end
	end

	table.insert(getgenv().TradeCache.Give[name], id)
	print("[GIVE]", name, id)
end

local function addReceive(name)
	if not name then return end
	table.insert(getgenv().TradeCache.Receive, name)
	print("[RECEIVE]", name)
end

-- scan id (กัน table ซ้อน)
local function scanId(v, cb)
	if type(v) == "string" and string.find(v, "unique_") then
		cb(v)
	elseif type(v) == "table" then
		for _, x in pairs(v) do
			scanId(x, cb)
		end
	end
end

-- ===============================
-- HOOK GIVE (REMOTE)
-- ===============================

local mt = getrawmetatable(game)
setreadonly(mt, false)
local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
	local args = {...}
	local method = getnamecallmethod()

	if method == "InvokeServer" and self == TradeAdd then
		task.wait() -- รอ GUI อัปเดต

		local unitName = getLatestName(GiveSF)
		scanId(args, function(id)
			addGive(unitName or "UNKNOWN", id)
		end)
	end

	return old(self, ...)
end)

-- ===============================
-- HOOK RECEIVE (GUI)
-- ===============================

ReceiveSF.ChildAdded:Connect(function(child)
	task.wait()
	local name = getUnitNameFromItem(child)
	addReceive(name)
end)

print("TRADE GIVE + RECEIVE TRACKER READY")
