-- =====================================
-- TRADE CACHE : GIVE (NAME+ID) / RECEIVE (NAME)
-- NO AUTO CLICK / NO AUTO ADD
-- =====================================

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local TradeAdd = RS.RemoteFunctions.TradeAddToOffer

-- GUI PATHS
local TradeGui =
	player.PlayerGui.GameGui.Screen.Middle.Trade

local GiveSF =
	TradeGui.Items.Container.Items.Left.Give.Items.ScrollingFrame

local ReceiveSF =
	TradeGui.Items.Container.Items.Right.Receive.Items.ScrollingFrame

-- ===============================
-- GLOBAL CACHE
-- ===============================

getgenv().TradeCache = getgenv().TradeCache or {
	Give = {},     -- [unitName] = { uniqueId1, uniqueId2 }
	Receive = {}   -- { unitName1, unitName2 }
}

-- ===============================
-- UTIL
-- ===============================

local function getUnitNameFromItem(item)
	for _, d in ipairs(item:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end
	return nil
end

local function getLatestFromSF(sf)
	local items = sf:GetChildren()
	if #items == 0 then return nil end
	return getUnitNameFromItem(items[#items])
end

local function addGive(name, id)
	if not name or not id then return end

	TradeCache.Give[name] = TradeCache.Give[name] or {}

	for _, v in ipairs(TradeCache.Give[name]) do
		if v == id then return end
	end

	table.insert(TradeCache.Give[name], id)
	print("[GIVE CACHED]", name, id)
end

local function addReceive(name)
	if not name then return end
	table.insert(TradeCache.Receive, name)
	print("[RECEIVE CACHED]", name)
end

local function scanId(v, cb)
	if type(v) == "string" and string.find(v, "unique_") then
		cb(v)
	elseif type(v) == "table" then
		for _, x in pairs(v) do
			scanId(x, cb)
		end
	end
end

-- ===============================
-- GIVE : REMOTE LISTENER (ID)
-- ===============================

local mt = getrawmetatable(game)
setreadonly(mt, false)
local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
	local args = {...}
	local method = getnamecallmethod()

	if method == "InvokeServer" and self == TradeAdd then
		task.wait() -- รอ GUI อัปเดต

		local unitName = getLatestFromSF(GiveSF)

		scanId(args, function(id)
			addGive(unitName or "UNKNOWN", id)
