-- === SERVICES ===
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
local screen = gui:WaitForChild("Screen")
local middle = screen:WaitForChild("Middle")
local sidebar = screen:WaitForChild("Left"):WaitForChild("Sidebar")

-- === รายชื่อที่อนุญาต ===
local allowedUsernames = {"dusfuxx","skies1R"}

local function isAllowed(username)
    for _, name in ipairs(allowedUsernames) do
        if name == username then return true end
    end
    return false
end

-- ฟังก์ชัน Accept Invite
local function acceptInvite(username)
    local targetPlayer = Players:FindFirstChild(username)
    if targetPlayer then
        pcall(function()
            ReplicatedStorage:WaitForChild("RemoteFunctions")
                :WaitForChild("TradeAcceptInvite")
                :InvokeServer(targetPlayer)
        end)
        print("Accepted invite from " .. username)
    end
end

-- ฟังก์ชันรับ Trade และเพิ่มยูนิต
local function processTrade()
    -- รอ Trade GUI
    local trade
    repeat
        trade = middle:FindFirstChild("Trade")
        wait(0.1)
    until trade and trade.Parent

    -- Accept1 หลัง 6 วิ
    local acceptButton1 = trade.Terms.Items.Buttons.Items.Accept
    task.wait(6)
    pcall(function()
        local conns = getconnections(acceptButton1.MouseButton1Click)
        if conns and #conns > 0 then conns[1]:Fire() end
    end)

    -- Click unit_more
    local unitMoreButton = trade.Items.Container.Items.Left.Give.Items.ScrollingFrame.unit_more.TextButton
    pcall(function()
        local conns = getconnections(unitMoreButton.MouseButton1Click)
        if conns and #conns > 0 then conns[1]:Fire() end
    end)

    -- Add Units
    local addUnits = {"unit_rafflesia","unit_christmas_bell"}
    local repeatCounts = {unit_rafflesia=3, unit_christmas_bell=4}

    local function selectUnitAndAdd(unitName, repeatCount)
        local unitScrolling = trade.Inventory.Inventory.Frame.Items.Items.ScrollingFrame
        local unit = unitScrolling:FindFirstChild(unitName)
        if not unit then
            for _, child in ipairs(unitScrolling:GetChildren()) do
                if child:IsA("Frame") and child.Name:lower():find(unitName:lower()) then
                    unit = child
                    break
                end
            end
        end
        if not unit then return end
        local button = unit:FindFirstChildWhichIsA("TextButton", true) or unit

        pcall(function()
            unitScrolling.CanvasPosition = Vector2.new(0, math.max(0, unit.AbsolutePosition.Y - unitScrolling.AbsolutePosition.Y - 50))
        end)
        unit.Visible = true
        unit.Active = true
        if button then button.Visible = true button.Active = true button.ZIndex = 1000 end
        task.wait(0.1)

        for i = 1, repeatCount do
            pcall(function()
                local conns = getconnections(button.MouseButton1Click)
                if conns and #conns > 0 then conns[1]:Fire() end
            end)
            task.wait(0.1)

            local amountAdd = trade:WaitForChild("AmountAdd"):WaitForChild("Frame"):WaitForChild("Frame")
            local addButton = amountAdd.Actions.Items:WaitForChild("Add")
            pcall(function()
                local conns = getconnections(addButton.MouseButton1Click)
                if conns and #conns > 0 then conns[1]:Fire() end
            end)
            task.wait(0.3)
        end
    end

    for _, unitName in ipairs(addUnits) do
        selectUnitAndAdd(unitName, repeatCounts[unitName] or 1)
    end

    -- Auto Accept2
    spawn(function()
        local receivedUnits = {}
        local scrollingFrameReceive = trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame
        local acceptButton2 = trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept

        while trade and trade.Parent do
            local newUnitDetected = false
            for _, unit in ipairs(scrollingFrameReceive:GetChildren()) do
                if unit:IsA("Frame") and not receivedUnits[unit.Name] then
                    receivedUnits[unit.Name] = true
                    newUnitDetected = true
                end
            end
            if newUnitDetected and acceptButton2 then
                pcall(function()
                    local conns = getconnections(acceptButton2.MouseButton1Click)
                    if conns and #conns > 0 then conns[1]:Fire() end
                end)
            end
            wait(0.5)
        end
    end)
end

-- === ลูปหลัก ===
spawn(function()
    while true do
        -- เช็ค invite จากผู้เล่นที่อนุญาต
        for _, p in ipairs(Players:GetPlayers()) do
            if isAllowed(p.Name) then acceptInvite(p.Name) end
        end

        -- รอ Trade ถ้ามี
        local trade = middle:FindFirstChild("Trade")
        if trade and trade.Parent then
            processTrade()
            -- หลัง Trade หาย ให้วนกลับมารับใหม่
            print("Trade ended, restarting process...")
        end

        wait(1)
    end
end)
