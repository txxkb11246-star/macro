-- === ACCEPT STEP 2 แบบ Real-Time เฉพาะตอนเพิ่ม/เปลี่ยนตัว ===
local receiveFrame = trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame
local acceptButton2 = trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept

local function fireAccept2()
    local connections = getconnections(acceptButton2.MouseButton1Click)
    if connections and #connections > 0 then
        connections[1]:Fire()
        updateStatus("กด Accept2 (ฝั่งตรงข้ามเพิ่ม/เปลี่ยนตัว)", Color3.fromRGB(0,200,0))
    end
end

-- เก็บสถานะยูนิตแบบละเอียด: { [unitName] = quantity }
local lastUnits = {}

local function getCurrentUnits()
    local units = {}
    for _, frame in ipairs(receiveFrame:GetChildren()) do
        if frame:IsA("Frame") then
            local name = frame.Name
            local amountValue = 1
            local label = frame:FindFirstChildWhichIsA("TextLabel")
            if label then
                local num = tonumber(label.Text)
                if num then amountValue = num end
            end
            units[name] = amountValue
        end
    end
    return units
end

while trade and trade.Parent do
    local currentUnits = getCurrentUnits()
    local changed = false

    -- ตรวจว่ามีการเพิ่มหรือเปลี่ยนจำนวน
    for name, amount in pairs(currentUnits) do
        if lastUnits[name] == nil or lastUnits[name] ~= amount then
            changed = true
            break
        end
    end

    -- ตรวจว่ามียูนิตที่ถูกลบ
    if not changed then
        for name,_ in pairs(lastUnits) do
            if currentUnits[name] == nil then
                changed = true
                break
            end
        end
    end

    -- Fire Accept2 เฉพาะตอนมีการเปลี่ยนแปลงจริง
    if changed then
        lastUnits = currentUnits
        fireAccept2()
    end

    task.wait(0.2)
end
