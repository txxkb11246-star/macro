-- =====================================
-- TRADE CACHE (SAFE HOOK VERSION)
-- =====================================

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local TradeAdd = RS.RemoteFunctions.TradeAddToOffer

-- GUI PATHS
local TradeGui = player.PlayerGui.GameGui.Screen.Middle.Trade
local GiveSF = TradeGui.Items.Container.Items.Left.Give.Items.ScrollingFrame
local ReceiveSF = TradeGui.Items.Container.Items.Right.Receive.Items.ScrollingFrame

-- CACHE
getgenv().TradeCache = {
	Give = {},
	Receive = {}
}

-- ===============================
-- UTIL
-- ===============================

local function getUnitNameFromItem(item)
	for _, d in ipairs(item:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end
end

local function getLatestGiveName()
	local items = GiveSF:GetChildren()
	if #items == 0 then return end
	return getUnitNameFromItem(items[#items])
end

local function addGive(name, id)
	if not name or not id then return end
	TradeCache.Give[name] = TradeCache.Give[name] or {}

	for _, v in ipairs(TradeCache.Give[name]) do
		if v == id then return end
	end

	table.insert(TradeCache.Give[name], id)
	print("[GIVE]", name, id)
end

local function addReceive(name)
	if not name then return end
	table.insert(TradeCache.Receive, name)
	print("[RECEIVE]", name)
end

local function scanId(v, cb)
	if type(v) == "string" and string.find(v, "unique_") then
		cb(v)
	elseif type(v) == "table" then
		for _, x in pairs(v) do
			scanId(x, cb)
		end
	end
end

-- ===============================
-- SAFE REMOTE HOOK
-- ===============================

hookmetamethod(game, "__namecall", function(self, ...)
	local args = {...}
	local method = getnamecallmethod()

	if method == "InvokeServer" and self == TradeAdd then
		task.wait()
		local unitName = getLatestGiveName()

		scanId(args, function(id)
			addGive(unitName or "UNKNOWN", id)
		end)
	end

	return self(...)
end)

-- ===============================
-- RECEIVE GUI LISTENER
-- ===============================

ReceiveSF.ChildAdded:Connect(function(child)
	task.wait()
	local name = getUnitNameFromItem(child)
	addReceive(name)
end)

print("TRADE CACHE READY (SAFE MODE)")
