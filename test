-- ======================================
-- AUTO TRADE ID COLLECTOR + AUTO REMOVE
-- ======================================

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local TradeAddToOffer =
	ReplicatedStorage.RemoteFunctions.TradeAddToOffer

local TradeRemoveFromOffer =
	ReplicatedStorage.RemoteFunctions.TradeRemoveFromOffer
	-- ⚠️ ถ้าชื่อไม่ตรง ดูจาก Remote Spy แล้วแก้ชื่อ

-- Cache
getgenv().CachedUnits = getgenv().CachedUnits or {}

local function addCache(unitName, itemId)
	getgenv().CachedUnits[unitName] = getgenv().CachedUnits[unitName] or {}

	for _, v in ipairs(getgenv().CachedUnits[unitName]) do
		if v == itemId then
			return
		end
	end

	table.insert(getgenv().CachedUnits[unitName], itemId)
	print("[CACHED]", unitName, "->", itemId)
end

-- ===============================
-- REMOTE HOOK
-- ===============================

local mt = getrawmetatable(game)
setreadonly(mt, false)

local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
	local args = {...}
	local method = getnamecallmethod()

	-- ===== ADD ITEM =====
	if method == "InvokeServer" and self == TradeAddToOffer then
		-- รูปแบบ args ที่พบบ่อย
		local itemId
		local unitName

		if type(args[1]) == "table" then
			itemId = args[1].id or args[1].ItemId or args[1].uniqueId
			unitName = args[1].name or args[1].UnitName
		else
			itemId = args[1]
			unitName = args[2] -- บางเกมส่งชื่อมาเป็น arg2
		end

		if itemId and unitName then
			addCache(unitName, itemId)

			-- เอาออกอัตโนมัติ (ไม่ให้ติด offer)
			task.delay(0.05, function()
				pcall(function()
					TradeRemoveFromOffer:InvokeServer(itemId)
					print("[AUTO REMOVE]", itemId)
				end)
			end)
		end
	end

	return old(self, ...)
end)

print("AUTO TRADE COLLECTOR READY")
