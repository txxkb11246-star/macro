-- =====================================
-- TRADE FULL RUM (SAFE)
-- GIVE : UID (Remote) + NAME (GUI)
-- RECEIVE : NAME (GUI)
-- NO WAIT IN __namecall
-- =====================================

-- ===== SERVICES =====
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- ===== REMOTE =====
local TradeAdd = RS.RemoteFunctions.TradeAddToOffer

-- ===== GUI PATHS =====
local TradeGui = player.PlayerGui.GameGui.Screen.Middle.Trade

local GiveSF =
	TradeGui.Items.Container.Items.Left.Give.Items.ScrollingFrame

local ReceiveSF =
	TradeGui.Items.Container.Items.Right.Receive.Items.ScrollingFrame

-- ===== CACHE =====
getgenv().TradeRum = getgenv().TradeRum or {
	Give = {},      -- [unitName] = { uid1, uid2 }
	Receive = {}    -- { unitName1, unitName2 }
}

-- ===== UTIL =====
local function getUnitNameFromItem(item)
	for _, d in ipairs(item:GetDescendants()) do
		if d:IsA("TextLabel") and d.Text ~= "" then
			return d.Text
		end
	end
end

local function getLatestGiveName()
	local items = GiveSF:GetChildren()
	if #items == 0 then return nil end
	return getUnitNameFromItem(items[#items])
end

local function addGive(name, uid)
	if not name or not uid then return end
	TradeRum.Give[name] = TradeRum.Give[name] or {}

	for _, v in ipairs(TradeRum.Give[name]) do
		if v == uid then return end
	end

	table.insert(TradeRum.Give[name], uid)
	print("[GIVE]", name, uid)
end

local function addReceive(name)
	if not name then return end
	table.insert(TradeRum.Receive, name)
	print("[RECEIVE]", name)
end

local function scanUID(v, cb)
	if type(v) == "string" and string.find(v, "unique_") then
		cb(v)
	elseif type(v) == "table" then
		for _, x in pairs(v) do
			scanUID(x, cb)
		end
	end
end

-- =====================================
-- GIVE : REMOTE HOOK (NO YIELD)
-- =====================================

local mt = getrawmetatable(game)
setreadonly(mt, false)
local old = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
	local args = {...}
	local method = getnamecallmethod()

	if method == "InvokeServer" and tostring(self) == "TradeAddToOffer" then
		-- ❗ ห้าม wait ตรงนี้
		task.defer(function()
			local unitName = getLatestGiveName()

			for _, v in ipairs(args) do
				scanUID(v, function(uid)
					addGive(unitName or "UNKNOWN", uid)
				end)
			end
		end)
	end

	return old(self, ...)
end)

-- =====================================
-- RECEIVE : GUI LISTENER (NAME ONLY)
-- =====================================

ReceiveSF.ChildAdded:Connect(function(child)
	task.defer(function()
		local name = getUnitNameFromItem(child)
		addReceive(name)
	end)
end)

print("TRADE FULL RUM READY (SAFE VERSION)")
