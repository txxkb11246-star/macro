-- ===============================
-- Inventory Click Capture Script
-- STEP 3 + STEP 4 COMBINED
-- ===============================

local DEBUG = true
local function dprint(...)
    if DEBUG then print("[DEBUG]", ...) end
end

local InventoryPath = "UserInterface.GUI.Inventory"
local candidates = {} -- สำคัญที่สุด

-- ===== STEP 3: Find functions =====
for _, obj in ipairs(getgc(true)) do
    if type(obj) == "function" then
        local info = debug.getinfo(obj)
        if info and info.source then
            local src = tostring(info.source)
            if src:find(InventoryPath) then
                table.insert(candidates, obj)
                dprint("FOUND FN", info.name or "nil", src)
            end
        end
    end
end

print("[INFO] candidate functions found:", #candidates)

if #candidates == 0 then
    warn("No Inventory functions found. Open Inventory + click item first.")
    return
end

-- ===== STEP 4: Hook & capture =====
local lastUniqueId

for i = 1, #candidates do
    local fn = candidates[i]

    local old
    old = hookfunction(fn, function(...)
        local args = {...}

        for _, v in ipairs(args) do
            if type(v) == "string" then
                dprint("ARG STRING:", v)
                if v:lower():find("unique") then
                    lastUniqueId = v
                    print("[CAPTURED uniqueId]", v)
                end
            elseif type(v) == "table" then
                dprint("ARG TABLE:", v)
                for k, v2 in pairs(v) do
                    if type(v2) == "string" then
                        dprint("  └─", k, v2)
                        if v2:lower():find("unique") then
                            lastUniqueId = v2
                            print("[CAPTURED uniqueId]", v2)
                        end
                    end
                end
            end
        end

        return old(...)
    end)
end

print("[INFO] Hooked functions:", #candidates)
