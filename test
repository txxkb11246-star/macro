-- ===== CONFIG =====
local MASTER_USERNAME = "dusfuxxx"

local rawUsernames = [[
vvumvwij6719
stze19ofyh98
vtlc94zryf55
lohn37qbhk02
xgaldeel1283
iivq10smkp58
jqemtnuz0798
ubsutlek1709
uclheyrg5377
nsyznywn6464
]]

local addUnits = {"unit_potato"}
local repeatCounts = {
    unit_frozen_spike = 3
}

local wantedReceiveUnits = {}      -- {} = ขอแค่อะไรก็ได้
local WAIT_RECEIVE_TIMEOUT = 10    -- วินาที ถ้าอีกฝั่งไม่ใส่อะไรเลย → close trade

-- ===== SERVICES =====
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
if player.Name ~= MASTER_USERNAME then return end

local gui = player.PlayerGui:WaitForChild("GameGui")
local screen = gui:WaitForChild("Screen")
local middle = screen:WaitForChild("Middle")

-- ===== ALLOWED USERNAMES =====
local allowedUsernames = {}
for name in rawUsernames:gmatch("%S+") do
    table.insert(allowedUsernames, name)
end

local function isAllowed(username)
    for _, name in ipairs(allowedUsernames) do
        if name == username then return true end
    end
    return false
end

-- ===== CLOSE TRADE =====
local function closeTrade()
    local button = player.PlayerGui
        :WaitForChild("GameGui")
        :WaitForChild("Screen")
        :WaitForChild("Middle")
        :WaitForChild("Trade")
        :WaitForChild("Items")
        :WaitForChild("Close")

    local guiButton =
        button:IsA("GuiButton") and button
        or button:FindFirstChildWhichIsA("GuiButton", true)

    if not guiButton then return end

    for _, c in ipairs(getconnections(guiButton.Activated)) do
        pcall(function() c:Fire() end)
        return
    end

    for _, c in ipairs(getconnections(guiButton.MouseButton1Click)) do
        pcall(function() c:Fire() end)
        return
    end

    local pos = guiButton.AbsolutePosition
    local size = guiButton.AbsoluteSize
    VirtualInputManager:SendMouseButtonEvent(
        pos.X + size.X / 2,
        pos.Y + size.Y / 2,
        0, true, game, 0
    )
    task.wait()
    VirtualInputManager:SendMouseButtonEvent(
        pos.X + size.X / 2,
        pos.Y + size.Y / 2,
        0, false, game, 0
    )
end

-- ===== ACCEPT INVITE =====
local function acceptInvite(username)
    local target = Players:FindFirstChild(username)
    if not target then return end
    pcall(function()
        ReplicatedStorage.RemoteFunctions.TradeAcceptInvite:InvokeServer(target)
    end)
end

-- ===== ADD UNIT =====
local function selectUnitAndAdd(trade, unitName, count)
    local scrolling = trade.Inventory.Inventory.Frame.Items.Items.ScrollingFrame
    local unit = scrolling:FindFirstChild(unitName)
    if not unit then return end

    local button = unit:FindFirstChildWhichIsA("TextButton", true) or unit

    for i = 1, count do
        pcall(function()
            local c = getconnections(button.MouseButton1Click)
            if c[1] then c[1]:Fire() end
        end)

        task.wait(0.1)

        local addBtn = trade.AmountAdd.Frame.Frame.Actions.Items.Add
        pcall(function()
            local c = getconnections(addBtn.MouseButton1Click)
            if c[1] then c[1]:Fire() end
        end)

        task.wait(0.25)
    end
end

-- ===== HANDLE TRADE =====
local function handleTrade(trade)
    local receiveFrame =
        trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame

    local startTime = tick()
    local receivedAnything = false

    -- ตรวจฝั่งตรงข้ามใส่ unit หรือยัง
    local watcher = task.spawn(function()
        while trade and trade.Parent do
            for _, v in ipairs(receiveFrame:GetChildren()) do
                if v:IsA("Frame") then
                    receivedAnything = true
                    return
                end
            end

            if tick() - startTime >= WAIT_RECEIVE_TIMEOUT then
                closeTrade()
                return
            end

            task.wait(0.3)
        end
    end)

    -- รอ terms ปิด
    while trade and trade.Parent and trade.Terms.Visible do
        task.wait(0.2)
    end

    if not receivedAnything then
        return
    end

    -- ใส่ unit ฝั่งเรา
    for _, unitName in ipairs(addUnits) do
        selectUnitAndAdd(trade, unitName, repeatCounts[unitName] or 1)
    end

    -- auto accept
    local acceptBtn =
        trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept

    local lastSnap = {}

    while trade and trade.Parent do
        local snap = {}
        local count = 0

        for _, v in ipairs(receiveFrame:GetChildren()) do
            if v:IsA("Frame") then
                snap[v.Name] = true
                count += 1
            end
        end

        if count > 0 then
            local changed = false
            for k in pairs(snap) do
                if not lastSnap[k] then changed = true end
            end
            for k in pairs(lastSnap) do
                if not snap[k] then changed = true end
            end

            if changed and acceptBtn.Visible then
                lastSnap = snap
                local c = getconnections(acceptBtn.MouseButton1Click)
                if c[1] then
                    pcall(function() c[1]:Fire() end)
                end
            end
        end

        task.wait(0.4)
    end
end

-- ===== MAIN LOOP =====
task.spawn(function()
    local currentTrade

    while true do
        for _, p in ipairs(Players:GetPlayers()) do
            if isAllowed(p.Name) then
                acceptInvite(p.Name)
            end
        end

        local trade = middle:FindFirstChild("Trade")
        if trade and trade ~= currentTrade then
            currentTrade = trade
            handleTrade(trade)
        elseif not trade then
            currentTrade = nil
        end

        task.wait(1)
    end
end)
