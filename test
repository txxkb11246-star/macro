local addUnits = {"unit_rafflesia", "unit_christmas_bell"}
local receiveUnits = {"unit_rafflesia"}
local repeatCounts = {
    unit_rafflesia = 3,
    unit_christmas_bell = 4
}
local targetUsername = "dusfuxx"

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
local screen = gui:WaitForChild("Screen")
local middle = screen:WaitForChild("Middle")
local sidebar = screen:WaitForChild("Left"):WaitForChild("Sidebar")

local tradeButton = sidebar.Items.Trade.Items.Button

local function fire(btn)
    local c = getconnections(btn.MouseButton1Click)
    if c and #c > 0 then c[1]:Fire() end
end

repeat
    fire(tradeButton)
    local frame = middle.TradePartner.Items.Items.Items.Items.ScrollingFrame
    local start = tick()
    while tick() - start < 5 do
        local item = frame:FindFirstChild(targetUsername)
        if item and item:FindFirstChild("Button") then
            fire(item.Button)
            break
        end
        task.wait(0.1)
    end
    task.wait(1)
until middle:FindFirstChild("Trade")

local trade = middle.Trade
local terms = trade.Terms

task.spawn(function()
    local btn = terms.Items.Buttons.Items.Accept
    while trade and trade.Parent and terms.Visible do
        fire(btn)
        task.wait(0.3)
    end
end)

repeat
    task.wait(0.1)
until not terms.Visible

task.wait(0.3)

fire(trade.Items.Container.Items.Left.Give.Items.ScrollingFrame.unit_more.TextButton)

local function getGiveCount(unitName)
    local f = trade.Items.Container.Items.Left.Give.Items.ScrollingFrame:FindFirstChild(unitName)
    if not f then return 0 end
    return tonumber(f.Frame.ImageLabel.Count.Text) or 0
end

local function addUnitOnce(unitName)
    local inv = trade.Inventory.Inventory.Frame.Items.Items.ScrollingFrame
    local u = inv:FindFirstChild(unitName)
    if not u then return end
    fire(u:FindFirstChildWhichIsA("TextButton", true))
    task.wait(0.1)
    fire(trade.AmountAdd.Frame.Frame.Actions.Items.Add)
end

local function bulkAdd(unitName, times)
    for i = 1, times do
        addUnitOnce(unitName)
        task.wait(0.12)
    end
end

for _, unit in ipairs(addUnits) do
    local need = repeatCounts[unit] or 1
    bulkAdd(unit, need)
end

task.wait(3)

for _, unit in ipairs(addUnits) do
    local need = repeatCounts[unit] or 1
    local rounds = 0
    while trade and trade.Parent do
        local current = getGiveCount(unit)
        if current >= need then break end
        addUnitOnce(unit)
        task.wait(0.5)
        rounds += 1
        if rounds >= 10 then break end
    end
end

task.spawn(function()
    local rf = trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame
    local ab = trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept
    local function ok()
        for _, i in ipairs(rf:GetChildren()) do
            if i:IsA("Frame") then
                if #receiveUnits == 0 then return true end
                for _, w in ipairs(receiveUnits) do
                    if i.Name == w then return true end
                end
            end
        end
        return false
    end
    while trade and trade.Parent do
        if ok() and ab.Visible and ab.Active then
            fire(ab)
        end
        task.wait(0.4)
    end
end)

repeat
    task.wait(0.2)
until not middle:FindFirstChild("Trade")

pcall(function() game:Shutdown() end)
