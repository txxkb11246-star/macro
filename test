-- === SERVICES ===
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
local screen = gui:WaitForChild("Screen")
local middle = screen:WaitForChild("Middle")

-- === CONFIG ===
local allowedUsernames = {"dusfuxx", "skies1R"}
local addUnits = {"unit_rafflesia", "unit_christmas_bell"}
local repeatCounts = {unit_rafflesia = 3, unit_christmas_bell = 4}

-- === UI STATUS ===
local function createStatusUI()
    local statusGui = Instance.new("ScreenGui")
    statusGui.Name = "TradeStatusUI"
    statusGui.ResetOnSpawn = false
    statusGui.Parent = player:WaitForChild("PlayerGui")
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0.5, 0, 0.2, 0)
    frame.Position = UDim2.new(0.25, 0, 0.4, 0)
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 0
    frame.Parent = statusGui
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Text = ""
    label.Parent = frame
    
    return label
end

local statusLabel = createStatusUI()
local function updateStatus(text, color)
    statusLabel.Text = text
    statusLabel.TextColor3 = color or Color3.fromRGB(255, 255, 255)
end

-- === FUNCTIONS ===
local function isAllowed(username)
    for _, name in ipairs(allowedUsernames) do
        if name == username then return true end
    end
    return false
end

local function acceptInvite(username)
    local targetPlayer = Players:FindFirstChild(username)
    if targetPlayer then
        pcall(function()
            ReplicatedStorage:WaitForChild("RemoteFunctions")
                :WaitForChild("TradeAcceptInvite")
                :InvokeServer(targetPlayer)
        end)
        updateStatus("Accepted invite from " .. username, Color3.fromRGB(0, 200, 255))
        print("Accepted invite from " .. username)
    end
end

local function selectUnitAndAdd(trade, unitName, repeatCount)
    updateStatus("Adding unit: "..unitName, Color3.fromRGB(255, 128, 0))
    local unitScrolling = trade.Inventory.Inventory.Frame.Items.Items.ScrollingFrame
    local unit = unitScrolling:FindFirstChild(unitName)
    if not unit then
        for _, child in ipairs(unitScrolling:GetChildren()) do
            if child:IsA("Frame") and child.Name:lower():find(unitName:lower()) then
                unit = child
                break
            end
        end
    end
    if not unit then
        warn("Unit not found:", unitName)
        return
    end
    local button = unit:FindFirstChildWhichIsA("TextButton", true) or unit
    pcall(function()
        unitScrolling.CanvasPosition = Vector2.new(
            0,
            math.max(0, unit.AbsolutePosition.Y - unitScrolling.AbsolutePosition.Y - 50)
        )
    end)
    unit.Visible = true
    unit.Active = true
    if button then
        button.Visible = true
        button.Active = true
        button.ZIndex = 1000
    end
    task.wait(0.1)
    for i = 1, repeatCount do
        pcall(function()
            local conns = getconnections(button.MouseButton1Click)
            if conns and #conns > 0 then
                conns[1]:Fire()
                print("Clicked unit:", unitName, "round", i)
            end
        end)
        task.wait(0.1)
        local amountAdd = trade:WaitForChild("AmountAdd"):WaitForChild("Frame"):WaitForChild("Frame")
        local addButton = amountAdd.Actions.Items:WaitForChild("Add")
        pcall(function()
            local conns = getconnections(addButton.MouseButton1Click)
            if conns and #conns > 0 then
                conns[1]:Fire()
                print("Clicked Add button for unit:", unitName, "round", i)
            end
        end)
        task.wait(0.3)
    end
end

-- === HANDLE TRADE ===
local function handleTrade(trade)
    updateStatus("Trade started", Color3.fromRGB(0, 255, 0))
    local tradeCompleted = false

    -- Accept1
    local acceptButton1 = trade.Terms.Items.Buttons.Items.Accept
    task.wait(6)
    local acceptConnections1 = getconnections(acceptButton1.MouseButton1Click)
    if acceptConnections1 and #acceptConnections1 > 0 then
        acceptConnections1[1]:Fire()
        updateStatus("Accept1 clicked", Color3.fromRGB(255, 255, 0))
        print("Accept1 clicked")
    end

    -- unit_more
    local unitMoreButton = trade.Items.Container.Items.Left.Give.Items.ScrollingFrame.unit_more.TextButton
    local unitMoreConnections = getconnections(unitMoreButton.MouseButton1Click)
    if unitMoreConnections and #unitMoreConnections > 0 then
        unitMoreConnections[1]:Fire()
        updateStatus("unit_more clicked", Color3.fromRGB(255, 128, 128))
        print("unit_more clicked")
    end

    -- Add Units
    for _, unitName in ipairs(addUnits) do
        local repeatCount = repeatCounts[unitName] or 1
        selectUnitAndAdd(trade, unitName, repeatCount)
    end

    -- Accept2 แบบเรียลไทม์ + cooldown
    spawn(function()
        local receivedUnits = {}
        local receiveFrame = trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame
        local acceptButton2 = trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept
        local acceptCooldown = false

        while trade and trade.Parent do
            local currentUnits = {}
            for _, frame in ipairs(receiveFrame:GetChildren()) do
                if frame:IsA("Frame") then
                    table.insert(currentUnits, frame.Name)
                end
            end

            if not acceptCooldown and #currentUnits ~= #receivedUnits then
                receivedUnits = currentUnits
                acceptCooldown = true
                -- Fire Accept2
                local connections = getconnections(acceptButton2.MouseButton1Click)
                if connections and #connections > 0 then
                    pcall(function()
                        connections[1]:Fire()
                        updateStatus("Accept2 fired!", Color3.fromRGB(0, 255, 128))
                        print("Accept2 fired!")
                    end)
                end
                task.delay(0.8, function() acceptCooldown = false end)
            end
            task.wait(0.2)
        end

        tradeCompleted = true
    end)

    -- รอจน Trade จบ
    while not tradeCompleted do
        task.wait(0.5)
    end

    updateStatus("Trade completed", Color3.fromRGB(255, 0, 255))
    task.wait(2)
end

-- === MAIN LOOP ===
spawn(function()
    local currentTrade = nil
    while true do
        for _, p in ipairs(Players:GetPlayers()) do
            if isAllowed(p.Name) then
                acceptInvite(p.Name)
            end
        end

        local trade = middle:FindFirstChild("Trade")
        if trade and trade.Parent and trade ~= currentTrade then
            currentTrade = trade
            handleTrade(trade)
        elseif not trade then
            currentTrade = nil
        end

        task.wait(1)
    end
end)
