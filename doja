local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local player = game.Players.LocalPlayer

local function parseNumber(str)
	str = tostring(str or "")
	local cleaned = str:gsub("[^%d]", "")
	return tonumber(cleaned) or 0
end

local function waitUntilCash(target)
	print("ðŸŸ¡ à¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸‡à¸´à¸™...")
	local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
	local cashLabel = gui:WaitForChild("Screen"):WaitForChild("Bottom"):WaitForChild("CurrencyDisplay"):WaitForChild("Cash")

	while true do
		local cashValue = parseNumber(cashLabel.Text)
		print("ðŸ’µ à¹€à¸‡à¸´à¸™à¸•à¸­à¸™à¸™à¸µà¹‰:", cashValue)
		if cashValue >= target then
			print("ðŸ’° à¹€à¸‡à¸´à¸™à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢:", target)
			break
		end
		task.wait(1)
	end
end

local function waitForUnitId(unitName, timeout)
	timeout = timeout or 5
	local startTime = tick()

	while tick() - startTime < timeout do
		local entities = Workspace:WaitForChild("Map"):WaitForChild("Entities")
		for _, unit in pairs(entities:GetChildren()) do
			if unit.Name == unitName and unit:GetAttribute("ID") and not placedUnits[unit:GetAttribute("ID")] then
				local id = unit:GetAttribute("ID")
				placedUnits[id] = unit
				return id
			end
		end
		task.wait(0.1)
	end
	return nil
end

local placedUnits = {}

local function placeUnit(unitName, position, pathIndex)
	local args = {
		unitName,
		{
			Valid = true,
			PathIndex = pathIndex or 1,
			Position = position,
			DistanceAlongPath = 0,
			CF = CFrame.new(position),
			Rotation = 0
		}
	}

	ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("PlaceUnit"):InvokeServer(unpack(args))

	local id = waitForUnitId(unitName, 5)
	if id then
		print("âœ… à¸§à¸²à¸‡ unit:", unitName, "ID:", id)
	else
		warn("âŒ à¹„à¸¡à¹ˆà¸žà¸š ID à¸‚à¸­à¸‡", unitName)
	end
	return id
end

-- â¬†ï¸ à¸­à¸±à¸›à¹€à¸à¸£à¸” unit
local function upgradeUnitById(id)
	if placedUnits[id] then
		local args = { id }
		ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("UpgradeUnit"):InvokeServer(unpack(args))
		print("ðŸ”¼ à¸­à¸±à¸›à¹€à¸à¸£à¸” unit ID:", id)
	else
		print("âŒ à¹„à¸¡à¹ˆà¸žà¸š unit ID:", id)
	end
end

local function ChooseMode()
local args = {
	"dif_apocalypse"
}
game:GetService("ReplicatedStorage"):WaitForChild("RemoteFunctions"):WaitForChild("PlaceDifficultyVote"):InvokeServer(unpack(args))
end

function again()
	local rs = game:GetService("ReplicatedStorage")
	local rf = rs:WaitForChild("RemoteFunctions")
	local restart = rf:WaitForChild("RestartGame")

	local ok, result = pcall(function()
		return restart:InvokeServer()
	end)
end

local RemoteEvents = ReplicatedStorage:WaitForChild("RemoteEvents")
local ShowGameEnd = RemoteEvents:WaitForChild("ShowGameEnd")

ShowGameEnd.OnClientEvent:Connect(function(...)
	task.wait(2)
	again()
end)

again()
ChooseMode()
task.wait(5)
local id1 = placeUnit("unit_rafflesia", Vector3.new(52.80524826049805, -21.75, -55.88352966308594), 1)
task.wait(13)
local id2 = placeUnit("unit_rafflesia", Vector3.new(-51.1591796875, -21.75, -49.975502014160156), 2)
task.wait(54)
local id3 = placeUnit("unit_rafflesia", Vector3.new(52.678672790527344, -21.75, -55.75695037841797), 3)
waitUntilCash(8000)
upgradeUnitById(id3)
