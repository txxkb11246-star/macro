local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local player = game.Players.LocalPlayer

local placedUnitIds = {}

-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≠‡∏à‡∏ô unit spawn ‡πÅ‡∏•‡∏∞‡∏°‡∏µ id
local function waitForUnitId(unitName, timeout)
    timeout = timeout or 5 -- ‡∏£‡∏≠‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    local startTime = tick()
    
    while tick() - startTime < timeout do
        local entitiesFolder = Workspace:WaitForChild("Map"):WaitForChild("Entities")
        for _, unit in pairs(entitiesFolder:GetChildren()) do
            if unit.Name == unitName and unit:GetAttribute("id") and not placedUnitIds[unit:GetAttribute("id")] then
                local id = unit:GetAttribute("id")
                placedUnitIds[id] = unit
                return id
            end
        end
        task.wait(0.1)
    end
    return nil -- ‡∏ñ‡πâ‡∏≤ timeout
end

-- ‡∏ß‡∏≤‡∏á unit ‡πÅ‡∏•‡∏∞‡∏£‡∏≠ id
local function placeUnit(unitName, position, pathIndex)
    local args = {
        unitName,
        {
            Valid = true,
            PathIndex = pathIndex or 1,
            Position = position,
            DistanceAlongPath = 0,
            CF = CFrame.new(position),
            Rotation = 0
        }
    }

    ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("PlaceUnit"):InvokeServer(unpack(args))
    
    -- ‡∏£‡∏≠‡∏à‡∏ô unit spawn ‡πÅ‡∏•‡∏∞‡∏°‡∏µ id
    local id = waitForUnitId(unitName, 5)
    if id then
        print("‚úÖ ‡∏ß‡∏≤‡∏á unit:", unitName, "ID:", id)
        return id
    else
        warn("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö unit id ‡∏Ç‡∏≠‡∏á", unitName)
        return nil
    end
end

-- ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î unit ‡∏ï‡∏≤‡∏° id
local function upgradeUnitById(id)
    if placedUnitIds[id] then
        ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("UpgradeUnit"):InvokeServer(id)
        print("üîº ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î unit ID:", id)
    else
        print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö unit ID:", id)
    end
end

-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
local id1 = placeUnit("unit_rafflesia", Vector3.new(47.6, -21.75, -50.68), 1)
if id1 then
    upgradeUnitById(id1)
end
