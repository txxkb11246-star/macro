local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local player = game.Players.LocalPlayer

local PlaceUnit = ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("PlaceUnit")

local placedUnits = {}
local lastPositions = { raff1=nil, raff2=nil, raff3=nil }
local forceRestart = false

local function cleanup()
	placedUnits = {}
	lastPositions = { raff1=nil, raff2=nil, raff3=nil }
	forceRestart = false
end

local function randomPositionAround(pos, radius)
	radius = radius or 5
	return Vector3.new(
		pos.X + (math.random()*2-1)*radius,
		pos.Y,
		pos.Z + (math.random()*2-1)*radius
	)
end

local function placeUnitRafflesia(unitName, pathIndex, basePos, minDist, maxDist, radius)
	radius = radius or 5
	local newPos
	local attempts = 0

	repeat
		newPos = randomPositionAround(basePos, radius)
		attempts += 1
	until lastPositions[unitName] ~= newPos or attempts > 10

	local distanceAlong = (minDist or 7) + math.random() * ((maxDist or 10) - (minDist or 7))

	pcall(function()
		PlaceUnit:InvokeServer(
			"unit_rafflesia",
			{
				Valid = true,
				PathIndex = pathIndex,
				Position = newPos,
				DistanceAlongPath = distanceAlong,
				CF = CFrame.new(newPos),
				Rotation = 180
			}
		)
	end)

	lastPositions[unitName] = newPos
	return newPos
end

local unitBases = {
	raff1 = Vector3.new(42.814, -21.75, -45.892),
	raff2 = Vector3.new(-44.658, -21.75, -43.475),
	raff3 = Vector3.new(41.676, -21.75, -44.754)
}

local function placeRaff1() return placeUnitRafflesia("raff1", 1, unitBases.raff1, 7, 10, 5) end
local function placeRaff2() return placeUnitRafflesia("raff2", 2, unitBases.raff2, 21, 24, 5) end
local function placeRaff3() return placeUnitRafflesia("raff3", 1, unitBases.raff3, 7, 10, 5) end

local function parseNumber(str)
	str = tostring(str or "")
	local cleaned = str:gsub("[^%d]", "")
	return tonumber(cleaned) or 0
end

local function waitUntilCash(target)
	local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
	local cashLabel = gui.Screen.Bottom.CurrencyDisplay.Cash

	while true do
		if forceRestart then return end
		local now = parseNumber(cashLabel.Text)
		if now >= target then break end
		task.wait(0.3)
	end
end

local function waitForUnitId(unitName, timeout)
	timeout = timeout or 15
	local start = tick()

	while tick() - start < timeout do
		if forceRestart then return nil end

		for _, unit in pairs(Workspace.Map.Entities:GetChildren()) do
			local idAttr = unit:GetAttribute("ID")
			if unit.Name == unitName and idAttr and not placedUnits[idAttr] then
				placedUnits[idAttr] = unit
				return idAttr
			end
		end
		task.wait(0.2)
	end
	return nil
end

local function placeUnitSafe(position, pathIndex)
	local id
	for attempt = 1, 3 do
		if forceRestart then return nil end

		PlaceUnit:InvokeServer(
			"unit_rafflesia",
			{
				Valid = true,
				PathIndex = pathIndex or 1,
				Position = position,
				DistanceAlongPath = 0,
				CF = CFrame.new(position),
				Rotation = 0
			}
		)

		id = waitForUnitId("unit_rafflesia", 15)
		if id then return id end
	end

	return nil
end

local function upgradeUnitById(id)
	if placedUnits[id] then
		ReplicatedStorage.RemoteFunctions.UpgradeUnit:InvokeServer(id)
	end
end

local function ChooseMode()
	ReplicatedStorage.RemoteFunctions.PlaceDifficultyVote:InvokeServer("dif_apocalypse")
end

local function again()
	pcall(function()
		ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
	end)
end

local gameEndConn = nil

local function setupEvents()
	if gameEndConn then
		gameEndConn:Disconnect()
	end

	gameEndConn = ReplicatedStorage.RemoteEvents.ShowGameEnd.OnClientEvent:Connect(function()
		forceRestart = true
	end)
end

setupEvents()

local function runSingleGame()
	cleanup()

	ChooseMode()
	task.wait(5)
	if forceRestart then return end

	local pos1 = placeRaff1()
	local id1 = placeUnitSafe(pos1, 1)
	if forceRestart then return end

	waitUntilCash(1250)
	if forceRestart then return end
	local pos2 = placeRaff2()
	local id2 = placeUnitSafe(pos2, 2)
	if forceRestart then return end

	waitUntilCash(9250)
	if forceRestart then return end
	local pos3 = placeRaff3()
	local id3 = placeUnitSafe(pos3, 1)
	if forceRestart then return end

	waitUntilCash(8000)
	if forceRestart then return end
	upgradeUnitById(id3)

	task.wait(15)
	if forceRestart then return end

	waitUntilCash(8000)
	if forceRestart then return end
	upgradeUnitById(id2)

	while not forceRestart do
		task.wait(0.5)
	end
end

while true do
	runSingleGame()
	again()
	task.wait(1)
end
