local addUnits = {"unit_rafflesia", "unit_christmas_bell"}
local receiveUnits = {"unit_rafflesia"}
local repeatCounts = {unit_rafflesia = 3, unit_christmas_bell = 4}
local targetUsername = "skies1R"

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
local screen = gui:WaitForChild("Screen")
local middle = screen:WaitForChild("Middle")
local sidebar = screen:WaitForChild("Left"):WaitForChild("Sidebar")

local tradeButton = sidebar.Items.Trade.Items.Button
local tradeConnections = getconnections(tradeButton.MouseButton1Click)
if tradeConnections and #tradeConnections > 0 then
    tradeConnections[1]:Fire()
end

local tradePartnerFrame = middle:WaitForChild("TradePartner"):WaitForChild("Items"):WaitForChild("Items"):WaitForChild("Items"):WaitForChild("Items"):WaitForChild("ScrollingFrame")

local function waitForUserAndClick(username)
    local targetItem
    local timeout = 5
    local startTime = tick()
    repeat
        targetItem = tradePartnerFrame:FindFirstChild(username)
        wait(0.1)
    until targetItem or tick() - startTime > timeout

    if targetItem then
        local button = targetItem:FindFirstChild("Button")
        if button then
            local userConnections = getconnections(button.MouseButton1Click)
            if userConnections and #userConnections > 0 then
                userConnections[1]:Fire()
            end
        end
    end
end

waitForUserAndClick(targetUsername)

local trade
repeat
    trade = middle:FindFirstChild("Trade")
    wait(0.1)
until trade

local acceptButton1 = trade.Terms.Items.Buttons.Items.Accept
task.wait(6)
local acceptConnections1 = getconnections(acceptButton1.MouseButton1Click)
if acceptConnections1 and #acceptConnections1 > 0 then
    acceptConnections1[1]:Fire()
end

local unitMoreButton = trade.Items.Container.Items.Left.Give.Items.ScrollingFrame.unit_more.TextButton
local unitMoreConnections = getconnections(unitMoreButton.MouseButton1Click)
if unitMoreConnections and #unitMoreConnections > 0 then
    unitMoreConnections[1]:Fire()
end

local function selectUnitAndAdd(unitName, repeatCount)
    local unitScrolling = trade.Inventory.Inventory.Frame.Items.Items.ScrollingFrame
    local unit = unitScrolling:FindFirstChild(unitName)
    if not unit then
        for _, child in ipairs(unitScrolling:GetChildren()) do
            if child:IsA("Frame") and child.Name:lower():find(unitName:lower()) then
                unit = child
                break
            end
        end
    end
    if not unit then
        return
    end

    local button = unit:FindFirstChildWhichIsA("TextButton", true) or unit
    pcall(function()
        unitScrolling.CanvasPosition = Vector2.new(0, math.max(0, unit.AbsolutePosition.Y - unitScrolling.AbsolutePosition.Y - 50))
    end)
    unit.Visible = true
    unit.Active = true
    if button then
        button.Visible = true
        button.Active = true
        button.ZIndex = 1000
    end

    task.wait(0.1)

    for i = 1, repeatCount do
        pcall(function()
            local conns = getconnections(button.MouseButton1Click)
            if conns and #conns > 0 then
                conns[1]:Fire()
            end
        end)
        task.wait(0.1)
        local amountAdd = trade:WaitForChild("AmountAdd"):WaitForChild("Frame"):WaitForChild("Frame")
        local addButton = amountAdd.Actions.Items:WaitForChild("Add")
        pcall(function()
            local conns = getconnections(addButton.MouseButton1Click)
            if conns and #conns > 0 then
                conns[1]:Fire()
            end
        end)
        task.wait(0.3)
    end
end

for _, unitName in ipairs(addUnits) do
    local repeatCount = repeatCounts[unitName] or 1
    selectUnitAndAdd(unitName, repeatCount)
end

local scrollingFrameReceive = trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame
local acceptButton = trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept

for _, unitName in ipairs(receiveUnits) do
    local unitFrame
    repeat
        unitFrame = scrollingFrameReceive:FindFirstChild(unitName)
        wait(0.1)
    until unitFrame
end

local connections = getconnections(acceptButton.MouseButton1Click)
if connections and #connections > 0 then
    connections[1]:Fire()
end

repeat
    trade = middle:FindFirstChild("Trade")
    wait(0.1)
until not trade

pcall(function()
    game:Shutdown()
end)
