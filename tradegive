-- ===== CONFIG =====
local addUnits = {"unit_rafflesia", "unit_christmas_bell"}
local receiveUnits = {"unit_rafflesia"} -- ว่าง {} = รับอะไรก็ได้
local repeatCounts = {
    unit_rafflesia = 3,
    unit_christmas_bell = 4
}
local targetUsername = "skies1R"

-- ===== SERVICES =====
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
local screen = gui:WaitForChild("Screen")
local middle = screen:WaitForChild("Middle")
local sidebar = screen:WaitForChild("Left"):WaitForChild("Sidebar")

-- ===== OPEN TRADE =====
local tradeButton = sidebar.Items.Trade.Items.Button

local function fireTradeButton()
    local conns = getconnections(tradeButton.MouseButton1Click)
    if conns and #conns > 0 then
        conns[1]:Fire()
    end
end

local function waitForUserAndClick(username)
    local frame = middle.TradePartner.Items.Items.Items.Items.ScrollingFrame
    local start = tick()
    while tick() - start < 5 do
        local item = frame:FindFirstChild(username)
        if item and item:FindFirstChild("Button") then
            local conns = getconnections(item.Button.MouseButton1Click)
            if conns and #conns > 0 then
                conns[1]:Fire()
                return
            end
        end
        task.wait(0.1)
    end
end

-- ===== WAIT TRADE =====
local trade
repeat
    fireTradeButton()
    waitForUserAndClick(targetUsername)
    trade = middle:FindFirstChild("Trade")
    task.wait(5)
until trade

-- ===== ACCEPT 1 =====
task.wait(6)
do
    local btn = trade.Terms.Items.Buttons.Items.Accept
    local conns = getconnections(btn.MouseButton1Click)
    if conns and #conns > 0 then
        conns[1]:Fire()
    end
end

-- ===== OPEN ADD UNIT PANEL =====
do
    local btn = trade.Items.Container.Items.Left.Give.Items.ScrollingFrame.unit_more.TextButton
    local conns = getconnections(btn.MouseButton1Click)
    if conns and #conns > 0 then
        conns[1]:Fire()
    end
end

-- ===== ADD UNITS =====
local function selectUnitAndAdd(unitName, count)
    local inv = trade.Inventory.Inventory.Frame.Items.Items.ScrollingFrame
    local unit = inv:FindFirstChild(unitName)

    if not unit then
        for _, v in ipairs(inv:GetChildren()) do
            if v:IsA("Frame") and v.Name:lower():find(unitName:lower()) then
                unit = v
                break
            end
        end
    end
    if not unit then return end

    local button = unit:FindFirstChildWhichIsA("TextButton", true) or unit
    inv.CanvasPosition = Vector2.new(0, math.max(0, unit.AbsolutePosition.Y - inv.AbsolutePosition.Y - 50))

    for i = 1, count do
        local conns = getconnections(button.MouseButton1Click)
        if conns and #conns > 0 then
            conns[1]:Fire()
        end
        task.wait(0.1)

        local addBtn = trade.AmountAdd.Frame.Frame.Actions.Items.Add
        local addConns = getconnections(addBtn.MouseButton1Click)
        if addConns and #addConns > 0 then
            addConns[1]:Fire()
        end
        task.wait(0.3)
    end
end

for _, u in ipairs(addUnits) do
    selectUnitAndAdd(u, repeatCounts[u] or 1)
end

-- ===== ACCEPT 2 (VERSION TODAY) =====
spawn(function()
    local receiveFrame = trade.Items.Container.Items.Right.Receive.Items.ScrollingFrame
    local acceptBtn = trade.Items.Container.Items.Right.Controls.Items.Buttons.Accept

    local function hasWantedUnit()
        local foundAny = false
        for _, item in ipairs(receiveFrame:GetChildren()) do
            if item:IsA("Frame") then
                foundAny = true
                if #receiveUnits == 0 then
                    return true
                end
                for _, want in ipairs(receiveUnits) do
                    if item.Name == want then
                        return true
                    end
                end
            end
        end
        return false
    end

    while trade and trade.Parent do
        if hasWantedUnit() and acceptBtn.Visible and acceptBtn.Active then
            local conns = getconnections(acceptBtn.MouseButton1Click)
            if conns and #conns > 0 then
                conns[1]:Fire()
            end
        end
        task.wait(0.4)
    end
end)

-- ===== WAIT END & SHUTDOWN =====
repeat
    trade = middle:FindFirstChild("Trade")
    task.wait(0.2)
until not trade

pcall(function()
    game:Shutdown()
end)
