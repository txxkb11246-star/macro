-- ===============================
-- ðŸŽ® Roblox Auto Game Loop Script (Tomato Version â€“ Fixed Memory Leak)
-- ===============================

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local player = game.Players.LocalPlayer

local PlaceUnit = ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("PlaceUnit")

-- ===============================
-- ðŸ”§ à¸•à¸±à¸§à¹à¸›à¸£à¸«à¸¥à¸±à¸
-- ===============================
local placedUnits = {}
local lastPositions = {
	toma1=nil, toma2=nil, toma3=nil,
	toma4=nil, toma5=nil, toma6=nil
}
local forceRestart = false

-- ===============================
-- ðŸ”¹ Cleanup à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™
-- ===============================
local function cleanup()
	placedUnits = {}
	lastPositions = {
		toma1=nil, toma2=nil, toma3=nil,
		toma4=nil, toma5=nil, toma6=nil
	}
	forceRestart = false
end

-- ===============================
-- ðŸ”¹ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸¸à¹ˆà¸¡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡
-- ===============================
local function randomPositionAround(pos, radius)
	radius = radius or 0.15
	return Vector3.new(
		pos.X + (math.random()*2-1)*radius,
		pos.Y,
		pos.Z + (math.random()*2-1)*radius
	)
end

-- ===============================
-- ðŸ”¹ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸§à¸²à¸‡ Tomato
-- ===============================
local function placeUnitTomato(unitKey, basePos, radius)
	radius = radius or 0.15
	local newPos
	local attempts = 0

	repeat
		newPos = randomPositionAround(basePos, radius)
		attempts += 1
	until lastPositions[unitKey] ~= newPos or attempts > 10

	local ok, err = pcall(function()
		PlaceUnit:InvokeServer(
			"unit_tomato_plant",
			{
				Valid = true,
				PathIndex = 1,
				Position = newPos,
				DistanceAlongPath = 0,
				CF = CFrame.new(newPos),
				Rotation = 180
			}
		)
	end)

	if not ok then warn("PlaceUnit failed:", err) end
	lastPositions[unitKey] = newPos
	return newPos
end

-- ===============================
-- ðŸ”¹ à¸ˆà¸¸à¸” base à¸‚à¸­à¸‡ Tomato
-- ===============================
local unitBases = {
	toma1 = Vector3.new(-331.2817, 61.6803, -132.8616),
	toma2 = Vector3.new(-331.5735, 61.6803, -128.9906),
	toma3 = Vector3.new(-327.7277, 61.6803, -132.9896),
	toma4 = Vector3.new(-327.8808, 61.6803, -128.7868),
	toma5 = Vector3.new(-325.9501, 61.6803, -129.1650),
	toma6 = Vector3.new(-325.9155, 61.6803, -133.3724)
}

local function placeToma1() return placeUnitTomato("toma1", unitBases.toma1) end
local function placeToma2() return placeUnitTomato("toma2", unitBases.toma2) end
local function placeToma3() return placeUnitTomato("toma3", unitBases.toma3) end
local function placeToma4() return placeUnitTomato("toma4", unitBases.toma4) end
local function placeToma5() return placeUnitTomato("toma5", unitBases.toma5) end
local function placeToma6() return placeUnitTomato("toma6", unitBases.toma6) end

-- ===============================
-- ðŸ”¥ Tracking + Unit ID + Upgrade
-- ===============================
local function parseNumber(str)
	str = tostring(str or "")
	local cleaned = str:gsub("[^%d]", "")
	return tonumber(cleaned) or 0
end

local function waitUntilCash(target)
	local gui = player:WaitForChild("PlayerGui"):WaitForChild("GameGui")
	local cashLabel = gui.Screen.Bottom.CurrencyDisplay.Cash
	while true do
		if forceRestart then return end
		local now = parseNumber(cashLabel.Text)
		if now >= target then break end
		task.wait(0.5)
	end
end

local function waitForUnitId(unitName, timeout)
	timeout = timeout or 15
	local start = tick()
	while tick() - start < timeout do
		if forceRestart then return nil end
		for _, unit in pairs(Workspace.Map.Entities:GetChildren()) do
			local idAttr = unit:GetAttribute("ID")
			if unit.Name == unitName and idAttr and not placedUnits[idAttr] then
				placedUnits[idAttr] = unit
				return idAttr
			end
		end
		task.wait(0.2)
	end
	return nil
end

local function placeUnitSafe(pos)
	local id
	for attempt = 1, 3 do
		if forceRestart then return nil end
		PlaceUnit:InvokeServer(
			"unit_tomato_plant",
			{
				Valid = true,
				PathIndex = 1,
				Position = pos,
				DistanceAlongPath = 0,
				CF = CFrame.new(pos),
				Rotation = 180
			}
		)
		id = waitForUnitId("unit_tomato_plant", 15)
		if id then return id end
	end
	warn("âŒ à¸§à¸²à¸‡ unit tomato à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ")
	return nil
end

local function upgradeUnitById(id)
	if placedUnits[id] then
		ReplicatedStorage.RemoteFunctions.UpgradeUnit:InvokeServer(id)
	end
end

-- ===============================
-- ðŸ”¥ à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”
-- ===============================
local function ChooseMode()
	ReplicatedStorage.RemoteFunctions.PlaceDifficultyVote:InvokeServer("dif_easy")
end

-- ===============================
-- ðŸ” Restart Game
-- ===============================
local function again()
	pcall(function()
		ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
	end)
end

-- ===============================
-- âš  Event â€“ à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² Event à¸‹à¹‰à¸­à¸™
-- ===============================
local gameEndConn = nil
local function setupEvents()
	if gameEndConn then gameEndConn:Disconnect() end
	gameEndConn = ReplicatedStorage.RemoteEvents.ShowGameEnd.OnClientEvent:Connect(function()
		forceRestart = true
	end)
end
setupEvents()

-- ===============================
-- ðŸŽ¯ One Game Loop (1 à¸£à¸­à¸šà¹€à¸à¸¡)
-- ===============================
local function runSingleGame()
	cleanup()
	ChooseMode()
	task.wait(5)

	local pos1 = placeToma1()
	local id1 = placeUnitSafe(pos1)
	if forceRestart then return end
    waitUntilCash(125)
	upgradeUnitById(id1)
    waitUntilCash(175)
	upgradeUnitById(id1)
    waitUntilCash(350)
	upgradeUnitById(id1)
    waitUntilCash(500)
	upgradeUnitById(id1)
	local pos2 = placeToma2()
	local id2 = placeUnitSafe(pos2)
	if forceRestart then return end
    waitUntilCash(125)
	upgradeUnitById(id2)
    waitUntilCash(175)
	upgradeUnitById(id2)
    waitUntilCash(350)
	upgradeUnitById(id2)
    waitUntilCash(500)
	upgradeUnitById(id2)
	local pos3 = placeToma3()
	local id3 = placeUnitSafe(pos3)
	if forceRestart then return end
    waitUntilCash(125)
	upgradeUnitById(id3)
    waitUntilCash(175)
	upgradeUnitById(id3)
    waitUntilCash(350)
	upgradeUnitById(id3)
    waitUntilCash(500)
	upgradeUnitById(id3)
	local pos4 = placeToma4()
	local id4 = placeUnitSafe(pos4)
	if forceRestart then return end
    waitUntilCash(125)
	upgradeUnitById(id4)
    waitUntilCash(175)
	upgradeUnitById(id4)
    waitUntilCash(350)
	upgradeUnitById(id4)
    waitUntilCash(500)
	upgradeUnitById(id4)
	local pos5 = placeToma5()
	local id5 = placeUnitSafe(pos5)
	if forceRestart then return end
    waitUntilCash(125)
	upgradeUnitById(id5)
    waitUntilCash(175)
	upgradeUnitById(id5)
    waitUntilCash(350)
	upgradeUnitById(id5)
    waitUntilCash(500)
	upgradeUnitById(id5)
	local pos6 = placeToma6()
	local id6 = placeUnitSafe(pos6)
    waitUntilCash(125)
	upgradeUnitById(id6)
    waitUntilCash(175)
	upgradeUnitById(id6)
    waitUntilCash(350)
	upgradeUnitById(id6)
    waitUntilCash(500)
	upgradeUnitById(id6)
	if forceRestart then return end
	while not forceRestart do
		task.wait(0.5)
	end
end

-- ===============================
-- ðŸš€ Main Loop
-- ===============================
while true do
	runSingleGame()
	again()
	task.wait(5)
end
